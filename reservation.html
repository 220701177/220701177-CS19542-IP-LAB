<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Table Booking</title>
    <link rel="stylesheet" href="stylee.css">
    <style>
        body {
            font-family: cursive;
            background-image: url('https://img.freepik.com/premium-photo/night-scene-empty-table-with-restaurant-background-ads_31965-623916.jpg?ga=GA1.1.165203865.1726297893&semt=ais_hybrid');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: #fbf4f7;
            text-align: center;
        }

        nav ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }
        nav ul li {
            margin: 0 15px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            font-size: 20px;
        }
        .booking-container {
            width: 40%;
            border: 2px solid white;
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            text-align: left;
        }
        h1, h2 {
            color: #f9eff4;
            font-family: cursive;
            text-align: center;
        }
        .datetime-section label {
            display: block;
            margin-bottom: 5px;
            color: white;
        }
        .datetime-section input {
            display: block;
            width: calc(100% - 20px);
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #b45f5f;
            border-radius: 5px;
            font-family: cursive;
        }
        .table-layout {
            display: none; /* Initially hide the table layout */
            margin-bottom: 20px;
        }
        .row {
            display: flex;
            justify-content: center; /* Center the tables in each row */
            margin-bottom: 15px;
        }
        .table {
            width: 60px;
            height: 60px;
            color: white;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .two-seater {
            background-color: #3e2e15;
        }
        .four-seater {
            background-color: #7b512c;
        }
        .ten-seater {
            background-color: #da9147;
        }
        .table.selected {
            border: 2px solid #f8f8f8;
            color: #000305;
        }
        .table.occupied {
            background-color: #ddd;
            cursor: not-allowed;
        }
        button {
            margin-top: 20px;
        }
        button[type="submit"], button[type="button"] {
            background-color: rgb(86, 46, 23);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-family: cursive;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        button[type="submit"]:hover, button[type="button"]:hover {
            background-color: #b66540;
        }
        footer {
            text-align: center;
            margin: 20px 0;
            color: black;
            font-size: 18px;
            font-weight: bold;
        }
        footer a {
            color: black;
            text-decoration: none;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<header>
    <h1>Reservation</h1>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="menu.html">Menu</a></li>
            <li><a href="reservation.html">Table Reservation</a></li>
            <li><a href="prebooking.html">Pre-book Food</a></li>
            <li><a href="contact.html">Location & Contact</a></li>
        </ul>
    </nav>
</header>

<div class="booking-container">
    <h1>Table Booking</h1>

    <div class="datetime-section">
        <label for="name">Your Name</label>
        <input type="text" id="name" name="name" placeholder="Enter your name" required>

        <label for="start-time">Start Time (Hour Only)</label>
        <input type="number" id="start-time" name="start-time" min="8" max="23" required placeholder="8-23 hours">

        <label for="end-time">End Time (Hour Only)</label>
        <input type="number" id="end-time" name="end-time" min="8" max="23" required placeholder="8-23 hours">
    </div>

    <button type="button" id="check-availability">Check Availability</button>

    <!-- Table Layout -->
    <div id="table-layout" class="table-layout">
        <h2>Two-Seater Tables</h2>
        <div class="row">
            <div class="table two-seater" data-seats="2" data-table="T1">T1</div>
            <div class="table two-seater" data-seats="2" data-table="T2">T2</div>
            <div class="table two-seater" data-seats="2" data-table="T3">T3</div>
        </div>

        <h2>Four-Seater Tables</h2>
        <div class="row">
            <div class="table four-seater" data-seats="4" data-table="T4">T4</div>
            <div class="table four-seater" data-seats="4" data-table="T5">T5</div>
            <div class="table four-seater" data-seats="4" data-table="T6">T6</div>
        </div>
        <div class="row">
            <div class="table four-seater" data-seats="4" data-table="T7">T7</div>
            <div class="table four-seater" data-seats="4" data-table="T8">T8</div>
            <div class="table four-seater" data-seats="4" data-table="T9">T9</div>
        </div>
        <div class="row">
            <div class="table four-seater" data-seats="4" data-table="T10">T10</div>
            <div class="table four-seater" data-seats="4" data-table="T11">T11</div>
            <div class="table four-seater" data-seats="4" data-table="T12">T12</div>
        </div>

        <h2>Ten-Seater Tables</h2>
        <div class="row">
            <div class="table ten-seater" data-seats="10" data-table="T14">T14</div>
            <div class="table ten-seater" data-seats="10" data-table="T15">T15</div>
        </div>

        <button type="submit">Reserve</button>
    </div>
</div>

<footer>
    <p>Powered by MYCAFÃ‰</p>
</footer>

<script>
    const tables = document.querySelectorAll('.table');
    const checkAvailabilityBtn = document.getElementById('check-availability');
    const reserveBtn = document.querySelector('button[type="submit"]');
    const tableLayout = document.getElementById('table-layout'); // Reference to the table layout

    // Function to fetch reservations without a date parameter
    async function fetchReservations() {
        console.log("Fetching reservations...");
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", `fetch_reservations.php`, true);
            xhr.onload = function () {
                if (this.status >= 200 && this.status < 300) {
                    console.log("Reservations fetched successfully:", this.responseText);
                    resolve(JSON.parse(this.responseText));
                } else {
                    console.error("Failed to fetch reservations:", this.status);
                    reject(new Error("Failed to fetch reservations"));
                }
            };
            xhr.onerror = function () {
                console.error("Network error while fetching reservations.");
                reject(new Error("Network error"));
            };
            xhr.send();
        });
    }

    checkAvailabilityBtn.addEventListener('click', async () => {
        const selectedName = document.getElementById('name').value;
        const selectedStartTime = parseInt(document.getElementById('start-time').value);
        const selectedEndTime = parseInt(document.getElementById('end-time').value);

        console.log("Selected Name:", selectedName);
        console.log("Selected Start Time:", selectedStartTime);
        console.log("Selected End Time:", selectedEndTime);

        if (selectedName && !isNaN(selectedStartTime) && !isNaN(selectedEndTime)) {
            try {
                const reservations = await fetchReservations();
                checkTableAvailability(reservations, selectedStartTime, selectedEndTime);

                // Show the table layout after checking availability
                tableLayout.style.display = 'block';

            } catch (error) {
                alert(error.message);
            }
        } else {
            alert("Please enter your name, start time, and end time.");
        }
    });

    function checkTableAvailability(reservations, startTime, endTime) {
        console.log("Checking table availability with reservations:", reservations);

        // Reset all tables to available
        tables.forEach(table => {
            table.classList.remove('occupied');
            table.classList.remove('selected');
            table.classList.add('available');
        });

        // Check for reservations and mark occupied tables
        reservations.forEach(reservation => {
            if (startTime < reservation.end_time && endTime > reservation.start_time) {
                const tableToOccupy = document.querySelector(`.table[data-table="${reservation.table_id}"]`);
                if (tableToOccupy) {
                    tableToOccupy.classList.add('occupied');
                    tableToOccupy.classList.remove('available');
                }
            }
        });
    }

    // Add click event listener for table selection
    tables.forEach(table => {
        table.addEventListener('click', () => {
            if (!table.classList.contains('occupied')) {
                tables.forEach(t => t.classList.remove('selected'));
                table.classList.add('selected');
            }
        });
    });

    // Handle reservation submission
    reserveBtn.addEventListener('click', () => {
        const selectedTable = document.querySelector('.table.selected');
        const selectedName = document.getElementById('name').value;
        const selectedStartTime = parseInt(document.getElementById('start-time').value);
        const selectedEndTime = parseInt(document.getElementById('end-time').value);

        if (selectedTable && selectedName && !isNaN(selectedStartTime) && !isNaN(selectedEndTime)) {
            const tableId = selectedTable.getAttribute('data-table');

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "reserve.php", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onload = function () {
                alert(this.responseText);
                if (this.responseText.includes("Reservation successful")) {
                    selectedTable.classList.add('occupied');
                    selectedTable.classList.remove('selected');

                    // Reload the page immediately after successful reservation
                    window.location.reload();
                }
            };
            xhr.send(`name=${encodeURIComponent(selectedName)}&start-time=${selectedStartTime}&end-time=${selectedEndTime}&table_id=${encodeURIComponent(tableId)}`);
        } else {
            alert("Please select a table and fill all the fields before reserving.");
        }
    });
</script>

</body>
</html>
